@page "/ordemservico"
@using AutoRepairShop.Components.Pages.Modals
@using AutoRepairShop.Components.Services
@using AutoRepairShop.DAL.Models
@using System.Text.Json
@inject ServiceOrderService serviceOrderService
@inject ProductService productService
@inject NavigationManager navManager
@rendermode InteractiveServer

<PageTitle>Ordem Serviço</PageTitle>

<h3>Ordem Serviço</h3>

<a href="servicesorderadd" class="btn btn-primary active mb-3 text-center" role="button" data-bs-toggle="button" aria-pressed="true">
    <i class="fas fa-plus"> Adicionar</i>
</a>
<div class="mt-5">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th class="fs-5 text-center">Número</th>
                <th class="fs-5 text-center">Veículo</th>
                <th class="fs-5 text-center">Autorizado</th>
                <th class="fs-5 d-flex justify-content-end">Opções</th>
            </tr>
        </thead>
        <tbody>
            @if(serviceOrders is not null){
                foreach(var serviceOrder in serviceOrders)
                {   <tr>
                        <td class="fs-5 text-center">@serviceOrder.OrderNumber</td>
                        <td class="fs-5 text-center">@serviceOrder.Value</td>
                        <td class="fs-5 text-center">@serviceOrder.Authorized</td>
                        <td class="fs-5 text-center"> 
                            <div class="divBotoes d-flex justify-content-end">
                                <a title="Editar" class="btn btn-secondary text-right float-right me-2" role="button" data-bs-toggle="button" @onclick="(() => Edit(serviceOrder.Id))">
                                    <i class="fas fa-pencil-alt"></i>
                                </a>
                                <a title="Excluir" class="btn btn-danger text-right float-right me-2" role="button" data-bs-toggle="button" @onclick="(() => Delete(serviceOrder))">
                                    <i class="fas fa-trash-alt"></i>
                                </a>
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal" @onclick = "(() => OpenModal(serviceOrder.Id))">
                                    <i class="fas fa-eye"/>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

<Modal @ref="Modal"></Modal>

@code{

    public List<ServiceOrder>? serviceOrders { get; set; }

    private Modal? Modal { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        serviceOrders = serviceOrderService.GetAll().ToList();
        await Task.CompletedTask;
    }

    public  void OpenModal(Guid id)
    {
        var serviceOrder = serviceOrderService.GetById(id);
        var prodQuant = JsonSerializer.Deserialize<List<ProductsUsed>>(serviceOrder!.ProductsUsed!);
        Modal!.Products = new List<ProductsUsed>();
        Modal!.Products.AddRange(prodQuant!);
        Modal!.Open();
        //Task.CompletedTask;
    }

    public void Edit(Guid id)
    {
        navManager.NavigateTo($"/servicesorderadd/{id}");
    }

    public async Task Delete(ServiceOrder serviceOrder)
    {
        await serviceOrderService.DeleteAsync(serviceOrder);
        navManager.Refresh(true);
    }
}